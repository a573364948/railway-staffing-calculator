# 商务座检测调试功能

## 问题背景

用户反映G2815次列车编组信息为"-"时，系统仍然显示有商务座并配备了人员。为了深入排查这个问题，我们添加了详细的调试功能。

## 添加的调试功能

### 🔍 **详细日志输出**

在 `utils/high-speed-rule-engine.ts` 的 `calculateTrainStaffing` 方法中添加了以下调试信息：

#### **1. 列车基本信息**
```typescript
console.log(`🚂 开始计算列车定员: ${trainNumber}`)
```

#### **2. 商务座检测详情**
```typescript
console.log(`📊 ${trainNumber} 商务座检测详情:`)
console.log(`   编组信息: "${formation}"`)
```

#### **3. 商务座服务员调整逻辑**
```typescript
console.log(`🔧 ${trainNumber} 商务座服务员调整逻辑:`)
console.log(`   规则配置商务座服务员: ${ruleStaffing.businessClassAttendant || 0}`)
console.log(`   是否有商务座: ${hasBusinessClass}`)
console.log(`   商务座车厢数: ${businessClassCount}`)
console.log(`   检测条件: hasBusinessClass=${hasBusinessClass}, businessClassCount=${businessClassCount}`)
```

#### **4. 配置结果**
```typescript
if (hasBusinessClass && businessClassCount > 0) {
  console.log(`   ✅ 配置商务座服务员: ${adjustedBusinessClassAttendant}人`)
} else {
  console.log(`   ❌ 取消商务座服务员配置`)
}
```

## 调试流程

### 📋 **排查步骤**

当G2815出现商务座配置问题时，可以通过以下步骤排查：

#### **1. 检查编组信息提取**
查看日志中的编组信息是否正确：
```
📊 G2815 商务座检测详情:
   编组信息: "null"  // 应该显示为 null，而不是 "-"
```

#### **2. 检查商务座检测逻辑**
查看 `hasBusinessClass` 和 `businessClassCount` 的值：
```
🔧 G2815 商务座服务员调整逻辑:
   是否有商务座: false     // 应该为 false
   商务座车厢数: 0         // 应该为 0
```

#### **3. 检查规则匹配**
查看匹配到的规则及其商务座配置：
```
   规则配置商务座服务员: 1  // 如果规则配置了商务座服务员
```

#### **4. 检查最终配置**
查看最终的商务座服务员配置：
```
   ❌ 取消商务座服务员配置  // 应该显示取消配置
```

## 可能的问题原因

### 🚨 **潜在问题点**

#### **1. 编组信息未正确过滤**
- **现象**：编组信息显示为 "-" 而不是 null
- **原因**：`extractFormation` 方法未正确识别空值标识符
- **解决**：已修复空值标识符检测逻辑

#### **2. 商务座检测逻辑错误**
- **现象**：`hasBusinessClass` 为 true，但编组信息为空
- **原因**：商务座检测的某个分支未正确处理空值
- **解决**：已修复 `hasBusinessClass` 方法中的空值处理

#### **3. 规则匹配问题**
- **现象**：匹配到了包含商务座配置的规则
- **原因**：G2815匹配到了默认规则（如"短编组-不限时间"）
- **解决**：需要检查规则匹配逻辑

#### **4. 商务座数量提取错误**
- **现象**：`businessClassCount` 不为 0
- **原因**：`extractBusinessClassCount` 方法未正确处理空值
- **解决**：已修复空值标识符检测逻辑

## 使用方法

### 🔧 **如何使用调试功能**

#### **1. 打开浏览器控制台**
- 按 F12 打开开发者工具
- 切换到 Console 标签页

#### **2. 执行定员计算**
- 在定员测算页面选择包含G2815的数据
- 点击"开始计算"

#### **3. 查看调试日志**
在控制台中查找以下格式的日志：
```
🚂 开始计算列车定员: G2815
📊 G2815 商务座检测详情:
   编组信息: "null"
🔧 G2815 商务座服务员调整逻辑:
   规则配置商务座服务员: 1
   是否有商务座: false
   商务座车厢数: 0
   检测条件: hasBusinessClass=false, businessClassCount=0
   ❌ 取消商务座服务员配置
```

#### **4. 分析问题**
根据日志输出分析问题所在：
- 如果编组信息不为 null，说明空值过滤有问题
- 如果 `hasBusinessClass` 为 true，说明商务座检测有问题
- 如果最终仍配置了商务座服务员，说明调整逻辑有问题

## 预期的正确行为

### ✅ **G2815的正确日志输出**

```
🚂 开始计算列车定员: G2815
📊 G2815 商务座检测详情:
   编组信息: "null"
🔍 高铁规则完全匹配: 编组=null, 运行时间=X小时
⚠️ 未找到完全匹配的规则
❌ G2815 未找到匹配的定员规则
```

或者如果匹配到规则：

```
🚂 开始计算列车定员: G2815
📊 G2815 商务座检测详情:
   编组信息: "null"
🔍 高铁规则完全匹配: 编组=null, 运行时间=X小时
✅ 找到完全匹配规则: [规则名称]
🔧 G2815 商务座服务员调整逻辑:
   规则配置商务座服务员: 1
   是否有商务座: false
   商务座车厢数: 0
   检测条件: hasBusinessClass=false, businessClassCount=0
   ❌ 取消商务座服务员配置
```

## 总结

通过添加详细的调试日志，我们可以：

- ✅ **精确定位问题**：清楚地看到每个步骤的处理结果
- ✅ **验证修复效果**：确认空值处理是否正确
- ✅ **排查规则匹配**：了解G2815匹配到了哪个规则
- ✅ **监控商务座逻辑**：确认商务座服务员配置是否正确

现在可以通过控制台日志详细了解G2815的处理过程，快速定位问题所在！
